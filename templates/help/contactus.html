<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Contact US</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      color-scheme: light dark;
      --bg: #f6f8fa;
      --card: #ffffff;
      --border: #d0d7de;
      --text: #222;
      --accent: #2563eb;
      --accent-hover: #1d4ed8;
      --danger: #b91c1c;
      --success: #15803d;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0f1115;
        --card: #1b1f24;
        --border: #30363d;
        --text: #e6e6e6;
      }
    }
    body {
      margin:0;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height:1.5;
    }
    header { padding:1.75rem 1rem 1rem; text-align:center; }
    h1 { margin:0 0 .5rem; font-size:1.6rem; }
    main {
      max-width:680px;
      margin:0 auto 3rem;
      padding:0 1rem;
    }
    form {
      background: var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:1.75rem 1.5rem 2rem;
      box-shadow:0 4px 10px -2px rgba(0,0,0,.06);
    }
    fieldset { border:none; margin:0; padding:0; }
    .field { margin-bottom:1.25rem; }
    label { display:block; font-weight:600; margin-bottom:.45rem; }
    input[type="number"], textarea {
      width:100%;
      font:inherit;
      padding:.7rem .85rem;
      border:1px solid var(--border);
      border-radius:8px;
      background:transparent;
      resize:vertical;
      min-height:110px;
      box-sizing:border-box;
    }
    input[type="number"]:focus, textarea:focus {
      outline:2px solid var(--accent);
      outline-offset:1px;
      border-color:var(--accent);
    }
    button {
      appearance:none;
      border:none;
      font:inherit;
      font-weight:600;
      background: var(--accent);
      color:#fff;
      padding:.9rem 1.4rem;
      border-radius:10px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:.5rem;
      min-width:140px;
      justify-content:center;
      transition: background .18s;
    }
    button:hover:not([disabled]) { background: var(--accent-hover); }
    button[disabled] { opacity:.6; cursor:progress; }
    .status {
      margin-top:1.25rem;
      font-size:.95rem;
      padding:.85rem 1rem;
      border-radius:8px;
      display:none;
      white-space:pre-line;
    }
    .status.show { display:block; }
    .status.error {
      background:#fee2e2;
      color: var(--danger);
      border:1px solid #fecaca;
    }
    .status.success {
      background:#dcfce7;
      color: var(--success);
      border:1px solid #bbf7d0;
    }
    .note {
      font-size:.8rem;
      color:#555;
      margin-top:.3rem;
    }
    @media (prefers-color-scheme: dark) {
      .status.error { background:#3b0d0d; border-color:#5c1c1c; }
      .status.success { background:#0f3a1f; border-color:#1f6b3a; }
      .note { color:#9aa0a6; }
    }
    .footer-info {
      margin-top:2rem;
      font-size:.75rem;
      opacity:.75;
      text-align:center;
    }
    .spinner {
      width:16px;
      height:16px;
      border:3px solid rgba(255,255,255,.5);
      border-top-color:#fff;
      border-radius:50%;
      animation: spin .8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .redirect-hint {
      margin-top:.6rem;
      font-size:.75rem;
      opacity:.8;
    }
  </style>
</head>
<body>
  <header>
    <h1>요청 메시지 등록</h1>
    <p>익명으로 필요한 사항을 관리자에게 전달할 수 있습니다.</p>
  </header>
  <main>
    <form id="reqForm" novalidate>
      <fieldset>
        <div>
          <label for="memberNo">관리자 메일 : ywpapa@gmail.com</label>
          <input style="display:none" type="text" id="memberNo" name="memberNo" placeholder="미등록사용자" value="0" />
        </div>
        <div class="field">
          <label for="message">메시지 (message)</label>
          <textarea id="message" name="message" placeholder="요청 내용을 입력하세요" required maxlength="2000"></textarea>
          <div class="note">최대 2000자.</div>
        </div>
      </fieldset>
      <button type="submit" id="submitBtn">
        <span class="btn-text">전송</span>
      </button>
      <div id="statusBox" class="status" role="alert" aria-live="polite"></div>
      <div id="redirectHint" class="redirect-hint" style="display:none;"></div>
    </form>
    <div class="footer-info"></div>
  </main>
  <script>
    (function init() {
      // 만약 스크립트를 <head>로 옮겼다면 아래 주석 해제:
      // if (document.readyState === 'loading') {
      //   document.addEventListener('DOMContentLoaded', init);
      //   return;
      // }

      const form = document.getElementById('reqForm');
      const statusBox = document.getElementById('statusBox');
      const submitBtn = document.getElementById('submitBtn');
      const btnTextSpan = submitBtn.querySelector('.btn-text');

      // redirectHint가 없으면 동적으로 생성 (안전)
      let redirectHint = document.getElementById('redirectHint');
      if (!redirectHint) {
        redirectHint = document.createElement('div');
          redirectHint.id = 'redirectHint';
          redirectHint.className = 'redirect-hint';
          redirectHint.style.display = 'none';
          form.appendChild(redirectHint);
      }

      const ENDPOINT = '/phapp/requestmessage';
      const DEFAULT_LOGIN_URL = '/';
      const REDIRECT_DELAY = 2000;

      function resolveLoginUrl() {
  const params = new URLSearchParams(location.search);
  const raw = params.get('redirect');
  if (!raw) return DEFAULT_LOGIN_URL;

  // 절대/상대 모두 처리 (두 번째 인자에 origin을 넣으면 상대경로도 OK)
  let u;
  try {
    u = new URL(raw, location.origin);
  } catch(e) {
    return DEFAULT_LOGIN_URL;
  }

  // 외부 도메인 차단
  if (u.origin !== location.origin) return DEFAULT_LOGIN_URL;

  // 최종 경로(쿼리 포함) 구성
  const candidate = u.pathname + u.search;

  // 허용 문자만 (백슬래시 금지)
  if (!/^\/[A-Za-z0-9/_?=&%.\-]*$/.test(candidate)) {
    return DEFAULT_LOGIN_URL;
  }
  return candidate;
}

      const LOGIN_URL = resolveLoginUrl();

      function setLoading(isLoading) {
        if (isLoading) {
          submitBtn.disabled = true;
          btnTextSpan.textContent = '';
          const sp = document.createElement('div');
          sp.className = 'spinner';
          submitBtn.appendChild(sp);
        } else {
          submitBtn.disabled = false;
          const sp = submitBtn.querySelector('.spinner');
          if (sp) sp.remove();
          btnTextSpan.textContent = '전송';
        }
      }

      function showStatus(message, type) {
        statusBox.textContent = message;
        statusBox.className = 'status show ' + type;
      }

      function parse422(detail) {
        if (!Array.isArray(detail)) return null;
        return detail.map(e => {
          const path = Array.isArray(e.loc) ? e.loc.join('.') : '';
          return path + ': ' + e.msg;
        }).join('\\n');
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        showStatus('', '');
        if (redirectHint) redirectHint.style.display = 'none';

        const memberNoInput = form.memberNo;
        const messageInput = form.message;

        if (!memberNoInput.value.trim()) {
          showStatus('memberNo 값을 입력하세요.', 'error');
          memberNoInput.focus();
          return;
        }
        if (!messageInput.value.trim()) {
          showStatus('메시지를 입력하세요.', 'error');
          messageInput.focus();
          return;
        }

          const payload = {
            memberNo: memberNoInput.value.trim(),
            message: messageInput.value.trim()
          };

        try {
          setLoading(true);
          const res = await fetch(ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          const ct = res.headers.get('content-type') || '';
          let data;
          if (ct.includes('application/json')) {
            data = await res.json().catch(() => ({}));
          } else {
            data = { raw: await res.text() };
          }

          if (!res.ok) {
            if (res.status === 422) {
              const parsed = parse422(data.detail) || JSON.stringify(data);
              throw new Error('검증 오류:\\n' + parsed);
            }
            const detail = (typeof data?.detail === 'string') ? data.detail : JSON.stringify(data);
            throw new Error('서버 오류: ' + detail);
          }

          if (data?.status === 'success') {
            showStatus('저장 성공! 로그인 페이지로 이동합니다...', 'success');
            form.reset();
            if (redirectHint) {
              redirectHint.style.display = 'block';
              redirectHint.textContent = `잠시 후 이동: ${LOGIN_URL}`;
            }
            setTimeout(() => {
              window.location.href = LOGIN_URL;
            }, REDIRECT_DELAY);
          } else {
            showStatus('응답 수신: ' + JSON.stringify(data), 'success');
          }
        } catch (err) {
          console.error(err);
          showStatus('전송 실패: ' + err.message, 'error');
        } finally {
          setLoading(false);
        }
      });
    })();
  </script>
</body>
</html>